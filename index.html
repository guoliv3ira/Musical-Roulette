<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sorteio Musical | guoliv3 & abacategotico</title>
    <style>
      :root {
        --spotify-green: #1db954;
        --bg-dark: #121212;
        --card-bg: #181818;
        --text-color: #ffffff;
      }

      body {
        font-family: "Circular", "Segoe UI", sans-serif;
        background-color: var(--bg-dark);
        color: var(--text-color);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }

      .container {
        background-color: var(--card-bg);
        padding: 2.5rem;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.8);
        text-align: center;
        max-width: 400px;
        width: 90%;
        border: 1px solid #282828;
      }

      .users {
        color: #b3b3b3;
        margin-bottom: 2rem;
        font-size: 0.8rem;
        font-weight: bold;
        letter-spacing: 2px;
      }

      button {
        background-color: var(--spotify-green);
        color: black;
        border: none;
        padding: 16px 20px;
        font-size: 1rem;
        font-weight: bold;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin: 10px 0;
      }

      button:hover {
        transform: scale(1.04);
        background-color: #1ed760;
      }
      button:disabled {
        background-color: #444;
        cursor: not-allowed;
        color: #888;
      }

      /* Estilo do Botão Revelar */
      #btn-revelar {
        background-color: transparent;
        color: var(--spotify-green);
        border: 2px solid var(--spotify-green);
        display: none; /* Escondido até o sorteio */
        margin-top: 20px;
      }

      #artista-imagem {
        width: 220px;
        height: 220px;
        border-radius: 12px;
        object-fit: cover;
        margin: 20px auto;
        display: none;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
      }

      .musica-card {
        background: #282828;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        display: none;
        text-align: left;
        border-left: 4px solid var(--spotify-green);
      }

      #status {
        font-size: 0.9rem;
        color: var(--spotify-green);
        margin-bottom: 10px;
        min-height: 1.2em;
      }
      #artista-nome {
        font-size: 1.8rem;
        font-weight: 900;
        margin-top: 10px;
      }
      a {
        color: var(--spotify-green);
        text-decoration: none;
        font-weight: bold;
      }
      a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 style="margin: 0">Musical Roulette</h1>
      <p class="users">GUOLIV3 + ABACATEGOTICO</p>

      <button id="btn-sortear" onclick="executarApp()">
        Sortear Artista (Top 1000)
      </button>

      <div id="status"></div>

      <div id="resultado-area">
        <img id="artista-imagem" src="" alt="Artista" />
        <div id="artista-nome"></div>
      </div>

      <button id="btn-revelar" onclick="revelarMusica()">Revelar Música</button>

      <div id="musica-card" class="musica-card">
        <div
          style="
            font-size: 0.7rem;
            color: #b3b3b3;
            margin-bottom: 5px;
            font-weight: bold;
          "
        >
          MAIOR SUCESSO HISTÓRICO:
        </div>
        <div id="musica-nome" style="font-size: 1.1rem"></div>
      </div>
    </div>

    <script>
      // --- INSIRA SUAS CHAVES AQUI ---
      const LASTFM_KEY = "5eab899dd6f841aaee2a0a136d1d99b6";
      const SPOTIFY_ID = "5294cb3376dc4401955848e1faf2d3b7";
      const SPOTIFY_SECRET = "dd73b445e857459088745073587997f3";

      const USER1 = "guoliv3";
      const USER2 = "abacategotico";

      // Função para mostrar o card da música
      function revelarMusica() {
        document.getElementById("musica-card").style.display = "block";
        document.getElementById("btn-revelar").style.display = "none";
      }

      async function getSpotifyToken() {
        const creds = btoa(`${SPOTIFY_ID}:${SPOTIFY_SECRET}`);
        const res = await fetch("https://accounts.spotify.com/api/token", {
          method: "POST",
          headers: {
            Authorization: `Basic ${creds}`,
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "grant_type=client_credentials",
        });
        const data = await res.json();
        return data.access_token;
      }

      async function fetchLastFM(user) {
        const url = `https://ws.audioscrobbler.com/2.0/?method=user.gettopartists&user=${user}&api_key=${LASTFM_KEY}&limit=1000&format=json`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.topartists) throw new Error("Erro ao carregar Last.fm");
        return data.topartists.artist.map((a) => a.name);
      }

      async function executarApp() {
        const btn = document.getElementById("btn-sortear");
        const btnRevelar = document.getElementById("btn-revelar");
        const status = document.getElementById("status");
        const img = document.getElementById("artista-imagem");
        const nome = document.getElementById("artista-nome");
        const mCard = document.getElementById("musica-card");
        const mNome = document.getElementById("musica-nome");

        // Reset UI para novo sorteio
        btn.disabled = true;
        status.innerText = "Cruzando bibliotecas...";
        mCard.style.display = "none";
        btnRevelar.style.display = "none";
        img.style.display = "none";
        nome.innerText = "";

        try {
          const [l1, l2] = await Promise.all([
            fetchLastFM(USER1),
            fetchLastFM(USER2),
          ]);
          const comuns = l1.filter((a) => l2.includes(a));

          if (comuns.length === 0) {
            nome.innerText = "Nada em comum no Top 1000.";
            status.innerText = "";
            return;
          }

          const sorteado = comuns[Math.floor(Math.random() * comuns.length)];
          nome.innerText = sorteado;
          status.innerText = "Buscando no Spotify...";

          const token = await getSpotifyToken();

          const sRes = await fetch(
            `https://api.spotify.com/v1/search?q=${encodeURIComponent(sorteado)}&type=artist&limit=1`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );
          const sData = await sRes.json();
          const art = sData.artists?.items[0];

          if (art) {
            img.src =
              art.images[0]?.url ||
              "https://via.placeholder.com/220?text=Sem+Foto";
            img.style.display = "block";

            // Busca as músicas. Usamos market=US para pegar a popularidade global estável
            let tRes = await fetch(
              `https://api.spotify.com/v1/artists/${art.id}/top-tracks?market=US`,
              {
                headers: { Authorization: `Bearer ${token}` },
              },
            );
            let tData = await tRes.json();

            // Fallback caso a busca de top-tracks falhe
            if (!tData.tracks || tData.tracks.length === 0) {
              const fallbackRes = await fetch(
                `https://api.spotify.com/v1/search?q=artist:${encodeURIComponent(sorteado)}&type=track&limit=1&market=US`,
                {
                  headers: { Authorization: `Bearer ${token}` },
                },
              );
              const fallbackData = await fallbackRes.json();
              if (fallbackData.tracks?.items?.length > 0) {
                tData = { tracks: [fallbackData.tracks.items[0]] };
              }
            }

            const track = tData.tracks?.[0];
            if (track) {
              mNome.innerHTML = `<a href="${track.external_urls.spotify}" target="_blank">▶ ${track.name}</a>`;
              btnRevelar.style.display = "inline-block"; // Mostra o botão para revelar
            } else {
              mNome.innerText = "Música não encontrada.";
            }
          } else {
            status.innerText = "Artista não encontrado no Spotify.";
          }
          status.innerText = "";
        } catch (e) {
          status.innerText = "Erro. Verifique o console.";
          console.error(e);
        } finally {
          btn.disabled = false;
        }
      }
    </script>
  </body>
</html>

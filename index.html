<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Musical Roulette | Spotify & Last.fm</title>
    <style>
      :root {
        --spotify-green: #1db954;
        --lastfm-red: #ba0000;
        --bg-dark: #121212;
        --card-bg: #181818;
        --text-color: #ffffff;
      }

      body {
        font-family: "Circular", "Segoe UI", sans-serif;
        background-color: var(--bg-dark);
        color: var(--text-color);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }

      .container {
        background-color: var(--card-bg);
        padding: 2.5rem;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7);
        text-align: center;
        max-width: 400px;
        width: 90%;
      }

      .users {
        color: #b3b3b3;
        margin-bottom: 2rem;
        font-size: 0.85rem;
        letter-spacing: 1px;
      }

      button {
        background-color: var(--spotify-green);
        color: black;
        border: none;
        padding: 14px 20px;
        font-size: 1rem;
        font-weight: bold;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin: 10px 0;
      }

      button:hover {
        transform: scale(1.04);
        filter: brightness(1.1);
      }
      button:disabled {
        background-color: #444;
        cursor: not-allowed;
        color: #888;
      }

      #artista-imagem {
        width: 200px;
        height: 200px;
        border-radius: 10px;
        object-fit: cover;
        margin: 20px auto;
        display: none;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      }

      .musica-card {
        background: #282828;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        display: none;
        text-align: left;
        border-left: 4px solid var(--spotify-green);
      }

      .loader {
        border: 4px solid #333;
        border-top: 4px solid var(--spotify-green);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: none;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 style="margin-top: 0">Sorteio Musical</h1>
      <p class="users">GUOLIV3 + ABACATEGOTICO</p>

      <button id="btn-sortear" onclick="executarApp()">
        Sortear Artista (Top 1000)
      </button>

      <div id="loader" class="loader"></div>

      <div id="resultado-artista">
        <img id="artista-imagem" src="" alt="Artista" />
        <div
          id="artista-nome"
          style="font-size: 1.6rem; font-weight: bold; margin-top: 10px"
        ></div>
      </div>

      <div id="musica-card" class="musica-card">
        <div style="font-size: 0.8rem; color: #b3b3b3; margin-bottom: 5px">
          POPULAR NO SPOTIFY:
        </div>
        <div
          id="musica-nome"
          style="font-weight: bold; font-size: 1.1rem"
        ></div>
      </div>
    </div>

    <script>
      // --- CONFIGURAÇÃO ---
      const LASTFM_KEY = "5eab899dd6f841aaee2a0a136d1d99b6";
      const SPOTIFY_CLIENT_ID = "5294cb3376dc4401955848e1faf2d3b7";
      const SPOTIFY_CLIENT_SECRET = "dd73b445e857459088745073587997f3";

      const USER1 = "guoliv3";
      const USER2 = "abacategotico";

      // Função para obter o Token do Spotify
      async function getSpotifyToken() {
        const url = "https://accounts.spotify.com/api/token";
        const credenciais = btoa(
          `${SPOTIFY_CLIENT_ID}:${SPOTIFY_CLIENT_SECRET}`,
        );

        const response = await fetch(url, {
          method: "POST",
          headers: {
            Authorization: `Basic ${credenciais}`,
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "grant_type=client_credentials",
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error("Erro na Autenticação Spotify:", errorData);
          throw new Error(
            `Spotify Auth Error: ${errorData.error_description || response.statusText}`,
          );
        }

        const data = await response.json();
        return data.access_token;
      }

      // Função para buscar dados do Artista e Música
      async function getSpotifyData(artistName, token) {
        // 1. Buscar o ID do Artista
        const searchUrl = `https://api.spotify.com/v1/search?q=${encodeURIComponent(artistName)}&type=artist&limit=1`;
        const searchRes = await fetch(searchUrl, {
          headers: { Authorization: `Bearer ${token}` },
        });

        const searchData = await searchRes.json();
        if (!searchData.artists.items.length)
          throw new Error("Artista não encontrado no Spotify");

        const artist = searchData.artists.items[0];

        // 2. Buscar as músicas mais ouvidas
        const tracksUrl = `https://api.spotify.com/v1/artists/${artist.id}/top-tracks?market=BR`;
        const trackRes = await fetch(tracksUrl, {
          headers: { Authorization: `Bearer ${token}` },
        });

        const trackData = await trackRes.json();
        const topTrack = trackData.tracks[0];

        return {
          img: artist.images[0]?.url || "https://via.placeholder.com/200",
          trackName: topTrack?.name || "Música não disponível",
          trackUrl: topTrack?.external_urls.spotify || "#",
        };
      }

      // Função principal do Last.fm
      async function fetchLastFMArtists(user) {
        const url = `https://ws.audioscrobbler.com/2.0/?method=user.gettopartists&user=${user}&api_key=${LASTFM_KEY}&limit=1000&format=json`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.error) throw new Error(`Last.fm Error: ${data.message}`);
        return data.topartists.artist.map((a) => a.name);
      }

      // Função que executa tudo ao clicar no botão
      async function executarApp() {
        const btn = document.getElementById("btn-sortear");
        const loader = document.getElementById("loader");
        const img = document.getElementById("artista-imagem");
        const nome = document.getElementById("artista-nome");
        const musicaCard = document.getElementById("musica-card");
        const musicaNome = document.getElementById("musica-nome");

        btn.disabled = true;
        loader.style.display = "block";
        musicaCard.style.display = "none";
        img.style.display = "none";

        try {
          const [lista1, lista2] = await Promise.all([
            fetchLastFMArtists(USER1),
            fetchLastFMArtists(USER2),
          ]);

          const comuns = lista1.filter((a) => lista2.includes(a));

          if (comuns.length === 0) {
            nome.innerText = "Nenhum artista em comum no Top 1000.";
          } else {
            const sorteado = comuns[Math.floor(Math.random() * comuns.length)];

            const token = await getSpotifyToken();
            const spotData = await getSpotifyData(sorteado, token);

            nome.innerText = sorteado;
            img.src = spotData.img;
            img.style.display = "block";

            musicaNome.innerHTML = `<a href="${spotData.trackUrl}" target="_blank" style="color: #1DB954; text-decoration: none;">▶ ${spotData.trackName}</a>`;
            musicaCard.style.display = "block";
          }
        } catch (error) {
          alert(error.message);
          console.error(error);
        } finally {
          loader.style.display = "none";
          btn.disabled = false;
        }
      }
    </script>
  </body>
</html>
